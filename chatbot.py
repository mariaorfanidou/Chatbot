import unicodedata
import difflib
from tabulate import tabulate

# Αφαίρεση τόνων
def remove_accents(text):
    return ''.join(
        c for c in unicodedata.normalize('NFD', text)
        if unicodedata.category(c) != 'Mn'
    )


# Λεξικό με απαντήσεις για κάθε θέμα
answers = {
    "στείρωση": "Η ιδανική ηλικία για να στειρώσετε τη γάτα σας είναι συνήθως μεταξύ 4 και 6 μηνών. Για τις θηλυκές γάτες, αυτό συμβαίνει πριν φτάσουν σε σεξουαλική ωριμότητα, η οποία είναι περίπου 6-7 μηνών. Οι αρσενικοί γάτοι μπορούν επίσης να στειρωθούν από 4 μηνών. ",
   # "μωρό": "Ο πρώτος ενισχυτικός εμβολιασμός για τα βασικά εμβόλια χορηγείται σε ηλικία μεταξύ 12 και 16 εβδομάδων.",
    "τσίπ": "Το τσιπ ειναι ασφαλές και μένει στη γάτα για όλη της τη ζωή. Είναι υποχρεωτικό από το κράτος για τον καλύτερο εντοπισμό τηα γάτας σε πρίπτωση που χαθεί",
    "εμβόλια": "Στη χώρα μας, ο ετήσιος εμβολιασμός κατά της λύσσας είναι υποχρεωτικός για τις γάτες. Επιπλέον, τα βασικά εμβόλια που συνιστώνται είναι αυτά για τη γρίπη της γάτας, τον ιό πανλευκοπενίας αιλουροειδών και τον ιό λευχαιμίας αιλουροειδών",
    "παράσιτα": "Η αντιμετώπιση των παρασίτων στις γάτες απαιτεί μια συνδυασμένη προσέγγιση, συμπεριλαμβανομένης της φαρμακευτικής αγωγής, της πρόληψης και της υγιεινής. Η επιλογή των κατάλληλων προϊόντων αντιπαρασιτικής αγωγής, η τακτική βούρτσισα και το μπάνιο, καθώς και οι επισκέψεις στον κτηνίατρο είναι απαραίτητες για να κρατήσετε τη γάτα σας υγιή.",
    "υιοθεσία": "Η υιοθεσία γάτας είναι μια υπέροχη απόφαση! Βεβαιωθείτε ότι έχετε χώρο, χρόνο και πόρους για να φροντίσετε τη γάτα σας. Επισκεφθείτε τοπικά καταφύγια ή οργανώσεις διάσωσης για να βρείτε την κατάλληλη γάτα για εσάς.",
    "κτηνίατρος": "Ο κτηνίατρος είναι ο ειδικός που θα σας καθοδηγήσει για την υγεία της γάτας σας. Συνιστάται να επισκέπτεστε τον κτηνίατρο τουλάχιστον μία φορά το χρόνο για προληπτική φροντίδα και εμβολιασμούς.",
    "παραπάνω": "Για παραπάνω πληροφορίες και πριν προχωρήσετε σε οποιαδήποτε ενέργεια επικοινωνήστε με τον κτηνιατρό σας.",
    "βιβλιαριο": "Το βιβλιάριο υγείας της γάτας σας είναι σημαντικό για την παρακολούθηση των εμβολιασμών και της γενικής υγείας της. Βεβαιωθείτε ότι το έχετε ενημερωμένο και το κρατάτε σε ασφαλές μέρος.",
    "φιλοζωική": "Η φιλοζωική είναι μια υπέροχη πρωτοβουλία! Υποστηρίξτε τις τοπικές οργανώσεις διάσωσης και υιοθεσίας γατών, προσφέροντας βοήθεια, πόρους ή υιοθετώντας μια γάτα.",
    "απόδραση": "Αν η γάτα σας έχει αποδράσει, προσπαθήστε να την εντοπίσετε άμεσα. Χρησιμοποιήστε το τσιπ της για να την βρείτε και ενημερώστε τις τοπικές αρχές και φιλοζωικές οργανώσεις.",
    "παιχνιδια": "Τα παιχνίδια είναι σημαντικά για τη διασκέδαση και την άσκηση της γάτας σας. Επιλέξτε ασφαλή και κατάλληλα παιχνίδια για γάτες, όπως μπάλες, φτερά και παιχνίδια με ήχο.",
    "διαθεση": "Η διάθεση της γάτας σας μπορεί να επηρεαστεί από πολλούς παράγοντες, όπως η υγεία, το περιβάλλον και η κοινωνικοποίηση. Παρακολουθήστε τη συμπεριφορά της και συμβουλευτείτε τον κτηνίατρο αν παρατηρήσετε αλλαγές.",
    "διατροφή": "Η σωστή διατροφή είναι κρίσιμη για την υγεία της γάτας σας. Επιλέξτε τροφές υψηλής ποιότητας, κατάλληλες για την ηλικία και τις ανάγκες της γάτας σας. Συμβουλευτείτε τον κτηνίατρο για τις καλύτερες επιλογές.",
    "διαβατηριο": "Το διαβατήριο γάτας είναι απαραίτητο για ταξίδια στο εξωτερικό. Περιλαμβάνει πληροφορίες για την υγεία της γάτας, τα εμβόλια και το τσιπ. Βεβαιωθείτε ότι έχετε όλα τα απαραίτητα έγγραφα πριν το ταξίδι.",
}

# Λέξεις-κλειδιά που αντιστοιχούν σε κάθε θέμα
keywords = {
    "στείρωση": ["στείρωση", "αναπαραγωγή", "επέμβαση", "αρσενικό", "θυληκό", "σεξουαλική ωριμότητα", "ορμές", "στειρώσω", "ανύσηχο", "συμπεριφορά"],
   # "μωρό": ["μωρό", "νεογένητο", "πρώτο", "εβδομάδες", "γατάκι", "μηνών", "βρήκα", "υιοθεσία"],
    "τσίπ": ["τσίπ", "μικροτσιπ", "εντοπισμός", "ατομικός αριθμός", "απώλεια", "εύρεση", "αριθμός τσιπ", "υποχρεωτικό", "κράτος", "ασφαλές", "αποδρασει", "σκασει"],
    "εμβόλια": ["εμβόλια", "ετήσιο", "εμβόλιο", "λύσσα", "βασικά", "γρίπη", "πανλευκοπενία", "λευχαιμία", "υποχρεωτικό"],
    "παράσιτα": ["παράσιτα", "τριχωμα", "μόλυνση", "δερματικό", "φαγούρα", "αποπαρασίτωση", "τσιμπούρι", "ψύλλοι", "σκουλήκια", "τριχοπτωση", "πέφτουν", "κενα τριχών", "αποπαρασιτωσεις", "παράσιτα γάτας", "ξυνεται", "φαγουριζεται"],
    "υιοθεσία": ["υιοθεσία", "βρήκα", "καταφύγιο", "διάσωση", "υιοθετώ", "υιοθετώ γάτα", "υιοθεσία γάτας", "γατάκι", "σπίτι"],
    "κτηνίατρος" :[ "κτηνίατρος", "κτηνιατρο", "γιατρο", "επίσκεψη", "υγειονομική περίθαλψη", "εξέταση", "διατροφή", "ευημερία", "υγεία", "συμβουλές", "βιβλιαριο", "εμβολιασμός", "προληπτική φροντίδα", "γιατρος", "κτηνίατρος"],
    "παραπάνω": ["παραπάνω", "περισσότερα", "επιπλέον", "άλλες πληροφορίες", "περισσότερες λεπτομέρειες", "επεξήγηση", "επιπλέον πληροφορίες", "περισσότερα για", "περισσότερες πληροφορίες", "αλλο"],
    "βιβλιαριο": ["βιβλιάριο", "υγείας", "υγειονομικό", "εμβολιασμός", "ιστορικό", "κτηνίατρος", "υγειονομική περίθαλψη", "υγειονομικό βιβλιάριο", "αρχείο", "υγειονομικό αρχείο", "υγειονομικό βιβλίο"],
    "φιλοζωική": ["φιλοζωική", "οργάνωση", "διάσωση", "υιοθεσία", "βοήθεια", "βοηθησω", "σωσω", "υποστήριξη", "ζωοφιλία", "αγάπη για τα ζώα", "κοινωνική ευθύνη", "ζωοφιλικές οργανώσεις"],
    "απόδραση": ["απόδραση", "διαφυγή", "χαθεί", "χαμένη", "βρέθηκε", "εντοπισμός", "αναζήτηση", "επιστροφή", "αποκατάσταση", "ανακάλυψη", "εχασα", "βρήκα", "αποδραση", "αποδρασεις", "εφυγε"],
    "παιχνιδια": ["παιχνίδια","γυμναστική", "διασκέδαση", "άσκηση", "δραστηριότητες", "παιχνίδι", "παιχνίδια γάτας", "διασκέδαση γάτας", "ασκήσεις γάτας", "παιχνίδια για γάτες", "παιχνίδια με γάτες", "μπάλα", "φτερά", "παιχνίδια με ήχο", "παιχνίδια με φως", "παιχνίδια με μυρωδιά", "μπάλες"],
    "διαθεση": ["διάθεση", "συμπεριφορά", "συναισθήματα", "ψυχολογία", "στεναχώριμενη", "άγχομενη", "φόβισμενη", "χαρά", "λύπημενη", "ανησυχη", "νευρικότητα", "ανησυχία γάτας", "αγχωμένη γάτα", "χαρούμενη γάτα", "λυπημένη γάτα", "νευρική γάτα"],
    "διατροφή": ["διατροφή", "τροφη", "τροφές", "τροφίμων", "διατροφή γάτας", "τροφές για γάτες", "διατροφή για γάτες", "τροφές υψηλής ποιότητας", "διατροφή υψηλής ποιότητας", "τροφές για γάτες", "διατροφή για γάτες", "υγιεινή διατροφή", "διατροφή γάτας"],
    "διαβατηριο": ["διαβατήριο", "ταξίδι", "έγγραφα", "υγειονομικό διαβατήριο", "διαβατήριο γάτας", "διαβατήριο για γάτες", "ταξίδι με γάτα", "ταξίδι στο εξωτερικό", "διαβατήριο για ταξίδι", "διαβατήριο για γάτες"]
}

# Normalize keywords (χωρίς τόνους)
def normalize_keywords(original_dict):
    cleaned = {}
    for topic, words in original_dict.items():
        cleaned[topic] = [remove_accents(w.lower()) for w in words]
    return cleaned

keywords = normalize_keywords(keywords)

# Εύρεση απάντησης με fuzzy matching
def find_answer(user_input):
    for topic, synonyms in keywords.items():
        for word in synonyms:
            if word in user_input:
                return answers[topic]

    all_keywords = []
    topic_map = {}
    for topic, words in keywords.items():
        for word in words:
            all_keywords.append(word)
            topic_map[word] = topic

    matches = difflib.get_close_matches(user_input, all_keywords, n=1, cutoff=0.7)
    if matches:
        matched_word = matches[0]
        matched_topic = topic_map[matched_word]
        return f"(Μήπως εννοούσες: '{matched_word}')\n{answers[matched_topic]}"

    return "Bot: Δεν κατάλαβα την ερώτησή σου. Δοκίμασε λέξεις όπως: στειρωση, τσιπ, εμβόλια, κτηνίατρος..."

# Καταγραφή ιστορικού σε αρχείο
def log_to_file(user_text, bot_response, filename="chat_history.txt"):
    with open(filename, "a", encoding="utf-8") as f:
        f.write(f"Εσύ: {user_text}\nBot: {bot_response}\n\n")

# Προβολή ιστορικού σε πίνακα
def read_history(filename="chat_history.txt"):
    try:
        with open(filename, "r", encoding="utf-8") as f:
            lines = f.readlines()

        rows = []
        question, answer = "", ""
        for line in lines:
            line = line.strip()
            if line.startswith("Εσύ:"):
                question = line[5:].strip()
            elif line.startswith("Bot:"):
                answer = line[5:].strip()
                rows.append([question, answer])

        if not rows:
            return "Bot: Δεν βρέθηκαν αποθηκευμένες συνομιλίες."

        return "📜 Ιστορικό συνομιλίας:\n" + tabulate(rows, headers=["Ερώτηση", "Απάντηση"], tablefmt="grid")

    except FileNotFoundError:
        return "Bot: Δεν υπάρχει αρχείο ιστορικού."

# Εκκαθάριση ιστορικού
def clear_history(filename="chat_history.txt"):
    try:
        with open(filename, "w", encoding="utf-8") as f:
            f.write("")
        return "Bot: Το ιστορικό διαγράφηκε επιτυχώς. 🧹"
    except Exception as e:
        return f"Bot: Σφάλμα: {e}"

# Κύριο loop chatbot
def chatbot():
    print("Bot: Ρώτα με για τη γάτα σου! Π.χ. 'Πότε να στειρώσω τη γάτα;'")
    print("Bot: Εντολές: 'ιστορικό' για προβολή | 'καθάρισε' για εκκαθάριση | 'τέλος' για έξοδο")

    while True:
        user_input = input("Εσύ: ").strip()
        cleaned_input = remove_accents(user_input.lower())

        if cleaned_input == remove_accents("τέλος"):
            print("Bot: Αντίο! 🐾")
            log_to_file(user_input, "Αντίο!")
            break

        if cleaned_input == remove_accents("ιστορικό"):
            print(read_history())
            continue

        if cleaned_input == remove_accents("καθάρισε"):
            confirm = input("Bot: Είσαι σίγουρος; Γράψε 'ναι' για επιβεβαίωση: ").strip().lower()
            if remove_accents(confirm) == "ναι":
                print(clear_history())
            else:
                print("Bot: Η εκκαθάριση ακυρώθηκε.")
            continue

        response = find_answer(cleaned_input)
        print(response)
        log_to_file(user_input, response)

# Εκκίνηση
chatbot()